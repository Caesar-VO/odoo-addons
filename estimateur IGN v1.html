<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Pure IGN ‚Äî Freeze & Zoom (up to √ó5) + Measure</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>

<!-- Map to canvas (tiles + vectors) -->
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

<style>
  html,body{height:100%;margin:0;background:#000}
  #map{position:fixed;inset:0}
  .area-label{background:rgba(0,0,0,.45);color:#fff;padding:4px 8px;border-radius:8px;font:14px system-ui;white-space:nowrap}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;
         padding:6px 10px;border-radius:8px;font:12px system-ui;opacity:0;transition:opacity .2s;z-index:1500;max-width:92vw}
  .toast.show{opacity:1}

  .toolbar{position:fixed;right:10px;top:10px;display:flex;gap:10px;z-index:1600}
  .btn{background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.15);
       font:13px system-ui;padding:8px 10px;cursor:pointer}
  .btn[hidden]{display:none}
</style>
</head>
<body>
<div id="map"></div>
<div class="toast" id="note"></div>

<!-- Top-right buttons -->
<div class="toolbar">
  <button class="btn" id="btnFreeze" title="Freeze & Zoom">üì∑ Freeze</button>
  <button class="btn" id="btnUnfreeze" title="Back to live" hidden>‚Ü©Ô∏è Unfreeze</button>
  <button class="btn" id="btnRaster" title="Toggle cadastre raster">Raster on/off</button>
</div>

<script>
/* ---------- Base layers (IGN, keyless) ---------- */
const URL_ORTHO =
  'https://data.geopf.fr/wmts?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile' +
  '&STYLE=normal&TILEMATRIXSET=PM&FORMAT=image/jpeg' +
  '&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}';

const URL_PARCELLAIRE =
  'https://data.geopf.fr/wmts?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile' +
  '&STYLE=normal&TILEMATRIXSET=PM&FORMAT=image/png' +
  '&LAYER=CADASTRALPARCELS.PARCELLAIRE_EXPRESS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}';

const ignOrthos = L.tileLayer(URL_ORTHO,{
  maxZoom:22,maxNativeZoom:21,attribution:'G√©oplateforme / ¬© IGN', crossOrigin:''   // CORS for export
});
const cadRaster = L.tileLayer(URL_PARCELLAIRE,{
  maxZoom:22,maxNativeZoom:21,opacity:.85,zIndex:600,attribution:'G√©oplateforme / ¬© IGN', crossOrigin:''
});

/* ---------- Map ---------- */
const map = L.map('map',{
  layers:[ignOrthos,cadRaster],
  maxZoom:22, minZoom:2,
  zoomSnap:1, zoomDelta:1,
  touchZoom:'center', bounceAtZoomLimits:false
}).setView([48.7064, 2.0382], 19); // Chevreuse

/* ---------- Draw + dynamic m¬≤ label ---------- */
const drawnItems = new L.FeatureGroup().addTo(map);
map.addControl(new L.Control.Draw({
  position:'topleft',
  draw:{ polygon:{ allowIntersection:false, showArea:false,
                   shapeOptions:{ color:'#1E88E5', weight:2, fillOpacity:.25 } },
         polyline:false, rectangle:false, circle:false, marker:false, circlemarker:false },
  edit:{ featureGroup: drawnItems, edit:true, remove:true }
}));
let poly=null,label=null;
const fmt=n=>!isFinite(n)?'‚Äì':(n>=100?Math.round(n).toLocaleString():n.toLocaleString(undefined,{maximumFractionDigits:2}));
const toGJ=l=>{const r=l.getLatLngs()[0].map(p=>[p.lng,p.lat]);const f=r[0],la=r[r.length-1];if(f[0]!==la[0]||f[1]!==la[1])r.push(f);return{type:"Feature",geometry:{type:"Polygon",coordinates:[r]}}};
function toast(msg){const t=document.getElementById('note');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}
function updateLabel(){
  if(!poly)return;
  const gj=toGJ(poly), a=turf.area(gj);
  const c=turf.centerOfMass(gj).geometry.coordinates, latlng=[c[1],c[0]];
  const html=`<div class="area-label" title="tap to copy">${fmt(a)} m¬≤</div>`;
  if(!label){
    label=L.marker(latlng,{icon:L.divIcon({className:'',html,iconSize:null})}).addTo(map);
    const copy=()=>navigator.clipboard && navigator.clipboard.writeText(`${Math.round(a)} m¬≤`).then(()=>toast('Copied m¬≤'));
    label.on('click',copy); label.on('tap',copy);
  } else { label.setLatLng(latlng); label.setIcon(L.divIcon({className:'',html,iconSize:null})); }
}
map.on(L.Draw.Event.CREATED,e=>{drawnItems.clearLayers(); if(label){map.removeLayer(label);label=null;} poly=e.layer; drawnItems.addLayer(poly); poly.on('edit',updateLabel); updateLabel();});
map.on('draw:edited',()=>poly&&updateLabel());
map.on('draw:deleted',()=>{poly=null; if(label){map.removeLayer(label);label=null;}});

/* ---------- Cadastre GeoJSON (Chevreuse fallback sequence) ---------- */
map.createPane('cadVectorPane'); map.getPane('cadVectorPane').style.zIndex=650;
function strokeW(z){ return Math.max(1, 0.5 + (z-18)*0.5); }
let cadVecGroup=null;
function buildVectorGroup(geojson){
  const w = strokeW(map.getZoom());
  const halo = L.geoJSON(geojson, { pane:'cadVectorPane', style:{ color:'#fff',     weight:w+2, opacity:0.9, fill:false }});
  const stroke= L.geoJSON(geojson, { pane:'cadVectorPane', style:{ color:'#ff6a00', weight:w,   opacity:1.0, fill:false }});
  const g = L.layerGroup([halo,stroke]); g._halo=halo; g._stroke=stroke; return g;
}
function restyleCad(){ if(cadVecGroup){const w=strokeW(map.getZoom()); cadVecGroup._halo.setStyle({weight:w+2}); cadVecGroup._stroke.setStyle({weight:w});}}
map.on('zoomend', restyleCad);

const DEP='78', INSEE='78160';
const BASE=`https://cadastre.data.gouv.fr/data/etalab-cadastre/latest/geojson/communes/${DEP}/${INSEE}`;
const ORDER=['parcelles','sections','batiments'];

(async ()=>{
  for (const t of ORDER){
    const url=`${BASE}/cadastre-${INSEE}-${t}.json.gz`;
    try{
      const res=await fetch(url,{cache:'no-cache',mode:'cors'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const ab=await res.arrayBuffer();
      const u8=new Uint8Array(ab);
      const isGz=u8.length>=2&&u8[0]===0x1f&&u8[1]===0x8b;
      const text=isGz?pako.ungzip(u8,{to:'string'}):new TextDecoder().decode(u8);
      const geo=JSON.parse(text);
      cadVecGroup && map.removeLayer(cadVecGroup);
      cadVecGroup = buildVectorGroup(geo).addTo(map);
      try{const b=cadVecGroup.getBounds(); if(b.isValid()) map.fitBounds(b.pad(0.05));}catch{}
      if(t!=='parcelles') toast(`Parcelles indisponibles ‚Äî ${t.toUpperCase()} affich√©`);
      break;
    }catch(e){ /* try next */ }
  }
})();

/* ---------- Raster on/off ---------- */
document.getElementById('btnRaster').addEventListener('click', ()=>{
  if(map.hasLayer(cadRaster)) map.removeLayer(cadRaster); else map.addLayer(cadRaster);
});

/* ================== FREEZE & ZOOM MODE ================== */
let frozen = false;
let frozenOverlay = null;
let savedLayers = null;
let savedZoomMax = map.options.maxZoom;

async function freezeView(){
  if(frozen) return;

  // Render current map (tiles + vectors) to a canvas
  const canvas = await new Promise((resolve,reject)=>{
    leafletImage(map, (err, c) => err ? reject(err) : resolve(c));
  }).catch(e=>{ toast('Capture √©chou√©e'); console.error(e); return null;});
  if(!canvas) return;

  const dataURL = canvas.toDataURL('image/png');
  const bounds = map.getBounds();

  // Remember live layers so we can restore
  savedLayers = [];
  map.eachLayer(l => savedLayers.push(l));

  // Remove live layers (but keep draw tools + feature group)
  savedLayers.forEach(l => { if(l!==drawnItems) map.removeLayer(l); });

  // Add the frozen image as overlay with same bounds
  frozenOverlay = L.imageOverlay(dataURL, bounds, {zIndex: 400}).addTo(map);

  // Allow extra zoom (√ó5) by bumping maxZoom and letting Leaflet upscale the image
  savedZoomMax = map.options.maxZoom;
  const extra = 5;
  map.setMaxZoom(savedZoomMax + extra);

  // Keep cadastre vectors above the frozen image if you want (comment next 2 lines to hide)
  if(cadVecGroup && !map.hasLayer(cadVecGroup)) cadVecGroup.addTo(map);

  frozen = true;
  document.getElementById('btnFreeze').hidden = true;
  document.getElementById('btnUnfreeze').hidden = false;
  toast('Mode photo: zoomez librement');
}

function unfreezeView(){
  if(!frozen) return;
  // Remove frozen image
  if(frozenOverlay){ map.removeLayer(frozenOverlay); frozenOverlay=null; }

  // Restore layers
  if(savedLayers){ savedLayers.forEach(l => { if(!map.hasLayer(l)) map.addLayer(l); }); }

  // Restore max zoom
  map.setMaxZoom(savedZoomMax);

  frozen = false;
  document.getElementById('btnFreeze').hidden = false;
  document.getElementById('btnUnfreeze').hidden = true;
  toast('Retour √† la carte en direct');
}

document.getElementById('btnFreeze').addEventListener('click', freezeView);
document.getElementById('btnUnfreeze').addEventListener('click', unfreezeView);

// Optional: while frozen you may still draw/edit polygons as usual (accuracy preserved)
// If you prefer to lock drawing during freeze, uncomment:
// map.on('draw:drawstart', ()=>{ if(frozen){ toast('Quittez le mode photo pour dessiner'); map.fire('draw:drawstop'); }});

</script>
</body>
</html>
